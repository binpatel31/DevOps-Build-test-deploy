---
# see the best practices in ansible docs for how to get started with creating roles etc.: 
# https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html

- hosts: localhost 
  tasks:
  - name: install jre8
    apt:
     name: openjdk-8-jre
     state: present
     update_cache: yes
    become: true

  - name: add jenkins repo key
    apt_key:
     url: https://pkg.jenkins.io/debian/jenkins.io.key
     state: present
    become: true

  - name: add jenkins repo list file into sources.list.d
    apt_repository:
     repo: deb http://pkg.jenkins.io/debian-stable binary/
     state: present
    become: true

  - name: install jenkins
    apt:
     name: jenkins
     state: present
     update_cache: yes
    become: true

  - name: install git
    apt:
     name: git
     state: present
    become: true

  - name: Set HTTP port in Jenkins config.
    lineinfile:
     backrefs: true
     dest: /etc/default/jenkins
     regexp: '^HTTP_PORT='
     line: 'HTTP_PORT=9000'
     mode: 0644
    register: jenkins_http_config
    become: true

  - name: Create initialization scripts directory
    file: path=/var/lib/jenkins/init.groovy.d
          state=directory
          owner=jenkins
          group=jenkins
          mode=0775
    become: true

  - name: Add initialization script to setup basic security
    template: src=security.groovy.j2
              dest=/var/lib/jenkins/init.groovy.d/security.groovy
    become: true

  - name: Bypass - jenkins.install.InstallUtil.lastExecVersion
    copy: src=/var/lib/jenkins/jenkins.install.UpgradeWizard.state
          dest=/var/lib/jenkins/jenkins.install.InstallUtil.lastExecVersion
          owner=jenkins
          group=jenkins
          remote_src=True
    become: true

  - stat: path=/var/lib/jenkins/secrets/initialAdminPassword
    register: adminpassword
    become: true

  - name: Bypass - initialAdminPassword
    shell: mv /var/lib/jenkins/secrets/initialAdminPassword /root
    when: adminpassword.stat.exists == True
    become: true

  - service: name=jenkins state=restarted
    become: true

